# 2023년 7월 14일(금)

---

### Today I Learned 

- [iOS-Swift] 클로저의 메모리 구조

---

## 클로저의 메모리

**클로저는 참조타입**

| 구분                  | 값 형식                                                      | 참조 형식                                                    |
| --------------------- | ------------------------------------------------------------ | ------------------------------------------------------------ |
| 타입                  | Value                                                        | Reference Type                                               |
| 메모리 상의 저장 위치 | 필요시에 항상 메모리의 값이 복사되어 전달 값의 저장: Stack   | 필요시에 항상 메모리의 주소를 전달 **값의 저장: Heap (주소를 Stack에 저장)** |
| 메모리 관리 방식      | 값이 들어있는 스택의 스코프가 종료되면 메모리에서 자동 제거  | RC(Reference Counting)을 통해 메모리를 관리 Swift에서 사용하는 ARC 모델 |
| 각형식의 타입 예시    | **스위프트 기본 타입(Int, String, …) 튜플, 구조체, 열거형, 컬렉션 등** | **클래스, 클로저**                                           |

**클로저의 메모리 구조**

```swift
// (클로저를 파라미터로 받는) 함수 정의
func closureFunction(closure: () -> ()) {
    print("Start Print")
    closure()
    print("End Print")
}

// 함수를 실행(호출)할 때 클로저 형태로 전달
closureFunction {
    print("Middle Print()")
}
```

- closureFunction(closure:) 을 실행(호출)할 때 메모리에서 발생하는 일 (print() 함수 스택프레임은 호출할 때 올라간다고 가정하고, 작성하지 않았습니다.)
  1. 스택에 있는 main() 프레임 위에 closureFunction() 프레임이 생성된다.
  2. closureFunction() 프레임 위에 closure() 스택 프레임이 생성된다.
  3. 힙 영역에 클로저의 메모리 주소를 담고 있는 공간이 생긴다.
  4. closure() 를 다 실행(실행할 때 3번 과정에서 생긴 힙 영역에 있는 클로저의 메모리 주소를 사용해서 코드 영역에 있는 클로저를 실행시킴) 하고 스택 프레임에서 없어지는데, 이 때 힙 영역을 가리키는 주소(클로저를 가리키는 주소)를 closureFunction()에게 해당 주소를 넘겨준다.
  5. closureFuction(closure:)을 다 실행하고 main() 에게 해당 주소(힙 영역을 가리키는 메모리 주소)를 넘겨준다.