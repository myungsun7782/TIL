# 2024-12-16-TIL

# 동기화와 교착 상태

- 아래 그림과 같이 프로세스 A가 공유 메모리 공간에 데이터를 쓰고, 프로세스 B가 해당 메모리 공간을 읽는 상황을 가정해 보자.
- 이 경우, 두 프로세스는 공유 메모리 공간이라는 자원을 공유하고 있는 셈임.
- 같은 프로세스의 자원을 공유하는 스레드 간 통신이 이루어지는 상황도 가정해 보자. 동일한 프로세스의 스레드 A와 B가 있고, 각각의 프로세스가 할당받은 파일을 수정하는 경우, 두 스레드는 파일 자원을 공유하고 있는 셈임.

<img width="741" alt="image" src="https://github.com/user-attachments/assets/347807e9-af2e-447f-8323-f1922903e66a">

(그림 출처: 이것이 취업을 위한 컴퓨터 과학이다.)

- 이렇게 프로세스 혹은 스레드가 공유하는 자원은 말 그대로 공유 자원(shared resource)이라고 함.
- 공유 자원은 메모리나 파일이 될 수도 있고, 전역 변수나 입출력장치가 될 수도 있음.
- 이때 공유 자원을 두고 동시다발적으로 실행되는 다수의 프로세스 혹은 스레드가 마구잡이로 실행된다면 어떨까요? 다수의 프로세스 혹은 스레드가 동시에 공유 자원에 접근할 경우 실행에 문제가 발생할 수 있음. 공유 자원에 접근하는 코드 중 동시에 실행했을 때 문제가 발생할 수 있는 코드는 **임계 구역(critical section)**이라고 함. 즉, 동시에 실행되는 프로세스나 스레드가 동시에 임계 구역에 진입하여 실행되면 문제가 발생할 수 있음.
- 예를 들어, 다음과 같은 그림에서 프로세스 A가 실행된 뒤 프로세스 B가 실행되는 것은 문제가 되지 않음. 하지만, 반대로 프로세스 B가 실행된 뒤에 프로세스 A가 실행되는 것은 문제가 될 수 있음. 아직 쓰이지 않은 메모리를 읽으려 했기 때문. 즉, 프로세스 A의 '공유 메모리 공간에 데이터를 쓰는 코드'와 프로세스 B의 '공유 메모리 공간을 읽는 코드'는 임계 구역이 됨.

<img width="704" alt="image" src="https://github.com/user-attachments/assets/19172be8-93a7-48d7-94c1-abe623c37fc0">

(그림 출처: 이것이 취업을 위한 컴퓨터 과학이다.)

- 동시에 파일을 수정하는 스레드도 생각해보자. 각 스레드들이 파일을 수정하는 과정은 파일을 읽어 들이고, 원하는 내용을 작성한 뒤, 작성한 내용은 저장하는 과정과 같음.
- 초기 파일에 저장된 값이 'first'라고 가정하고, 스레드 A는 'thread A'를 파일에 추가하는 작업, 스레드 B는 'thread B'를 파일에 추가하는 작업을 수행한다고 가정해보자. 다음과 같이 스레드 A와 B가 동시에 수행될 경우, 스레드 A의 작업 내역은 반영되지 않을 수 있음.

<img width="792" alt="image" src="https://github.com/user-attachments/assets/bc8d5a8d-a0e3-4af4-bd60-f39ecb120710">

(그림 출처: 이것이 취업을 위한 컴퓨터 과학이다.)

- 혹은 실행 도중에 다음과 같이 문맥 교환이 발생하는 경우에도 스레드 A의 작업은 반영되지 않을 수 있음. 따라서, 각 스레드가 파일을 수정하는 코드는 임계 구역이 됩니다.

<img width="796" alt="image" src="https://github.com/user-attachments/assets/77890b03-4d42-4602-8dc1-f0f64f05351e">

(그림 출처: 이것이 취업을 위한 컴퓨터 과학이다.)

- 이처럼 동시다발적으로 실행되는 프로세스 혹은 스레드를 다룰 때는 언제나 임계 구역을 동시에 실행하지 않도록 유의해야 한다. 앞선 예시처럼 프로세스 혹은 스레드가 동시에 임계 구역의 코드를 실행하여 문제가 발생하는 상황을 **레이스 컨디션(race condition)**이라고 함.
- 레이스 컨디션이 발생하면 자원의 일관성이 손상될 수 있기 때문에 2개 이상의 프로세스 혹은 스레드가 임계 영역에 진입하고자 한다면 둘 중 하나는 작업이 끝날 때까지 대기해야 함.
- 레이스 컨디션을 방지하면서 임계 구역을 관리하기 위해서는 프로세스와 스레드가 동기화되어야 함. 프로세스 혹은 스레드 **동기화(synchronization)**란 다음의 2가지 조건을 준수하며 실행하는 것을 의미함.
  - **실행 순서 제어**: 프로세스 및 스레드를 올바른 순서로 실행하기
  - **상호 배제**: 동시에 접근해서는 안 되는 자원에 하나의 프로세스 및 스레드만 접근하기

